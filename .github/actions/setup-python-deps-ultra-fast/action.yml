name: 'Setup Python Dependencies (Ultra Fast)'
description: 'Ultra-fast dependency setup using wheel cache and lockfile-based resolution'
inputs:
  python-version:
    description: 'Python version to use'
    required: false
    default: '3.11'
  test-type:
    description: 'Type of test (unit, integration, performance, coverage)'
    required: true
  working-directory:
    description: 'Working directory for installation'
    required: false
    default: 'packages/eol-rag-context'

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    # Multi-layer caching strategy
    - name: Cache pip wheels and packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.cache/uv
          ~/.local/share/uv
        key: pip-wheels-${{ runner.os }}-py${{ inputs.python-version }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/uv.lock') }}
        restore-keys: |
          pip-wheels-${{ runner.os }}-py${{ inputs.python-version }}-
          pip-wheels-${{ runner.os }}-

    - name: Cache ML models
      if: inputs.test-type == 'integration' || inputs.test-type == 'coverage'
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/torch
          ~/.cache/huggingface
        key: ml-models-${{ runner.os }}-all-MiniLM-L6-v2
        restore-keys: |
          ml-models-${{ runner.os }}-

    - name: Cache virtual environment
      uses: actions/cache@v4
      with:
        path: ${{ inputs.working-directory }}/.venv-${{ inputs.python-version }}
        key: venv-${{ runner.os }}-py${{ inputs.python-version }}-${{ inputs.test-type }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/uv.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ inputs.python-version }}-${{ inputs.test-type }}-
          venv-${{ runner.os }}-py${{ inputs.python-version }}-

    # Try to download pre-built wheel cache using GitHub CLI (cross-workflow compatible)
    - name: Check for wheel cache availability
      id: check-wheels
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "🔍 Checking for pre-built wheel cache availability..."
        echo "WHEELS_AVAILABLE=false" >> $GITHUB_ENV
        echo "WHEEL_CACHE_STATUS=checking" >> $GITHUB_ENV

        # Try to find recent wheel cache artifacts using GitHub CLI
        echo "🔎 Looking for wheel cache from recent dependency optimization runs..."

        # Search for recent successful workflow runs that created wheel caches
        if gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[] | select(.name == "Dependency Optimization") | .id' > /dev/null 2>&1; then
          echo "📋 Found Dependency Optimization workflow"

          # Get the most recent successful run ID
          recent_run=$(gh api repos/${{ github.repository }}/actions/workflows/dependency-optimization.yml/runs \
            --jq '.workflow_runs[] | select(.conclusion == "success") | .id' | head -1 2>/dev/null || echo "")

          if [ -n "$recent_run" ]; then
            echo "🎯 Found recent successful run: $recent_run"

            # Try to download the artifact using GitHub CLI
            if gh run download "$recent_run" --name "wheels-py${{ inputs.python-version }}" --dir /tmp/wheels-cache 2>/dev/null; then
              echo "📦 Successfully downloaded wheel cache from run $recent_run"

              # Extract and validate
              if tar xzf /tmp/wheels-cache/wheels-py${{ inputs.python-version }}.tar.gz 2>/dev/null; then
                if [ -d ".wheels-py${{ inputs.python-version }}" ] && [ "$(ls -A .wheels-py${{ inputs.python-version }} 2>/dev/null | wc -l)" -gt 0 ]; then
                  echo "WHEELS_AVAILABLE=true" >> $GITHUB_ENV
                  echo "WHEEL_DIR=$PWD/.wheels-py${{ inputs.python-version }}" >> $GITHUB_ENV
                  echo "WHEEL_CACHE_STATUS=success" >> $GITHUB_ENV
                  echo "✅ Using pre-built wheels: $(ls .wheels-py${{ inputs.python-version }} | wc -l) packages (from run $recent_run)"
                else
                  echo "WHEEL_CACHE_STATUS=empty" >> $GITHUB_ENV
                fi
              else
                echo "WHEEL_CACHE_STATUS=extract_failed" >> $GITHUB_ENV
              fi
            else
              echo "WHEEL_CACHE_STATUS=download_failed" >> $GITHUB_ENV
            fi
          else
            echo "WHEEL_CACHE_STATUS=no_recent_runs" >> $GITHUB_ENV
          fi
        else
          echo "WHEEL_CACHE_STATUS=no_workflow" >> $GITHUB_ENV
        fi

        # Final fallback status
        if [ "$WHEEL_CACHE_STATUS" = "checking" ]; then
          echo "WHEEL_CACHE_STATUS=unavailable" >> $GITHUB_ENV
        fi

    - name: Install uv
      shell: bash
      run: |
        if ! command -v uv &> /dev/null; then
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        fi

    - name: Setup virtual environment
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        if [ ! -d ".venv-${{ inputs.python-version }}" ]; then
          echo "🔧 Creating virtual environment..."
          uv venv .venv-${{ inputs.python-version }} --python ${{ inputs.python-version }}
        else
          echo "✅ Using cached virtual environment"
        fi

    - name: Install dependencies (ultra-fast with wheels)
      if: env.WHEELS_AVAILABLE == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "⚡ Installing from pre-built wheels..."
        uv pip install \
          --python .venv-${{ inputs.python-version }}/bin/python \
          --find-links "$WHEEL_DIR" \
          --no-index \
          pytest pytest-asyncio pytest-timeout pytest-xdist \
          -r requirements.txt || {
          echo "⚠️ Wheel installation failed, falling back to index"
          export WHEELS_AVAILABLE=false
        }

    - name: Install base dependencies (fallback)
      if: env.WHEELS_AVAILABLE != 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "📦 Installing base dependencies..."
        uv pip install \
          --python .venv-${{ inputs.python-version }}/bin/python \
          --compile-bytecode \
          pytest pytest-asyncio pytest-timeout pytest-xdist \
          -r requirements.txt

    - name: Install test-specific dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "🔧 Installing ${{ inputs.test-type }}-specific dependencies..."

        case "${{ inputs.test-type }}" in
          unit)
            uv pip install --python .venv-${{ inputs.python-version }}/bin/python \
              pytest-cov sentence-transformers
            ;;
          integration)
            uv pip install --python .venv-${{ inputs.python-version }}/bin/python \
              pytest-cov redis redisvl sentence-transformers aioredis \
              watchdog gitignore-parser
            ;;
          performance)
            uv pip install --python .venv-${{ inputs.python-version }}/bin/python \
              pytest-benchmark sentence-transformers
            ;;
          coverage)
            uv pip install --python .venv-${{ inputs.python-version }}/bin/python \
              pytest-cov redis redisvl sentence-transformers aioredis
            ;;
        esac

    - name: Install system dependencies
      if: inputs.test-type == 'integration' || inputs.test-type == 'coverage'
      shell: bash
      run: |
        if ! command -v redis-cli &> /dev/null; then
          echo "📦 Installing Redis CLI..."
          sudo apt-get update && sudo apt-get install -y redis-tools
        fi

    - name: Pre-download ML models
      if: (inputs.test-type == 'integration' || inputs.test-type == 'coverage') && steps.download-wheels.outcome != 'success'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "📥 Pre-downloading sentence transformer models..."
        .venv-${{ inputs.python-version }}/bin/python -c \
          "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')" || true

    - name: Report setup method
      shell: bash
      run: |
        echo "🔧 Dependency Setup Summary:"
        echo "  Python Version: ${{ inputs.python-version }}"
        echo "  Test Type: ${{ inputs.test-type }}"
        echo "  Environment: .venv-${{ inputs.python-version }}"

        case "$WHEEL_CACHE_STATUS" in
          success)
            echo "  ⚡ Installation Method: Pre-built wheel cache (ULTRA-FAST)"
            echo "  📊 Performance: ~5-10s dependency setup"
            ;;
          no_workflow)
            echo "  📦 Installation Method: PyPI with aggressive caching"
            echo "  📊 Performance: ~30-60s dependency setup (first run), ~10-20s (cached)"
            echo "  💡 Tip: Dependency Optimization workflow not found - wheels unavailable"
            ;;
          no_recent_runs)
            echo "  📦 Installation Method: PyPI with aggressive caching"
            echo "  📊 Performance: ~30-60s dependency setup (first run), ~10-20s (cached)"
            echo "  💡 Tip: No recent successful wheel builds - trigger dependency optimization"
            ;;
          download_failed)
            echo "  📦 Installation Method: PyPI with aggressive caching"
            echo "  📊 Performance: ~30-60s dependency setup (first run), ~10-20s (cached)"
            echo "  ⚠️ Issue: Wheel cache download failed - check artifact retention"
            ;;
          empty|extract_failed)
            echo "  ⚠️ Installation Method: PyPI fallback (wheel cache corrupted)"
            echo "  📊 Performance: ~30-60s dependency setup"
            echo "  🔧 Action: Re-run dependency optimization workflow to rebuild cache"
            ;;
          unavailable|*)
            echo "  📦 Installation Method: PyPI with caching (default)"
            echo "  📊 Performance: ~30-60s dependency setup"
            ;;
        esac
