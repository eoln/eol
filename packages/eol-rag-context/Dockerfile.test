# Optimized test image for eol-rag-context integration tests
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    redis-tools \
    git \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv for fast package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Create virtual environment and install Python dependencies with uv
RUN uv venv /venv
ENV VIRTUAL_ENV=/venv
ENV PATH="/venv/bin:$PATH"

# Install Python dependencies with uv (much faster than pip)
RUN uv pip install \
    pytest \
    pytest-asyncio \
    pytest-cov \
    pytest-timeout \
    pytest-xdist \
    redis \
    redisvl \
    sentence-transformers \
    aioredis \
    watchdog \
    gitignore-parser \
    tomli \
    typer \
    rich \
    fastmcp \
    numpy \
    pydantic

# Pre-download sentence transformer model
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')"

WORKDIR /app
